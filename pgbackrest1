High-Level Architecture
Host
â”œâ”€â”€ /pgbackrest/
â”‚   â””â”€â”€ repo/              â† backups stored here (host)
â”œâ”€â”€ /pgdata/               â† postgres data (host)
â””â”€â”€ docker container
    â”œâ”€â”€ PostgreSQL
    â”œâ”€â”€ pgBackRest
    â””â”€â”€ cron (for backups)

Step 1: Directory Layout on Host

Backups must live outside the container.

/pgdata            -> PostgreSQL data directory
/pgbackrest/repo   -> pgBackRest repository

Step 2: Custom Docker Image (Postgres + pgBackRest)
Dockerfile
FROM postgres:15

RUN apt-get update && \
    apt-get install -y pgbackrest cron && \
    rm -rf /var/lib/apt/lists/*

# pgBackRest directories
RUN mkdir -p /var/log/pgbackrest /etc/pgbackrest

COPY pgbackrest.conf /etc/pgbackrest/pgbackrest.conf
COPY backup-cron /etc/cron.d/pgbackrest

RUN chmod 0644 /etc/cron.d/pgbackrest && \
    crontab /etc/cron.d/pgbackrest

CMD ["bash", "-c", "cron && docker-entrypoint.sh postgres"]

pgbackrest.conf
[global]
repo1-path=/var/lib/pgbackrest
repo1-retention-full=7
log-level-console=info
start-fast=y

[main]
pg1-path=/var/lib/postgresql/data

backup-cron (daily full backup)
0 2 * * * postgres pgbackrest --stanza=main backup --type=full

Step 3: Ansible Playbook Structure
ansible/
â”œâ”€â”€ inventory
â”œâ”€â”€ playbook.yml
â”œâ”€â”€ files/
â”‚   â”œâ”€â”€ Dockerfile
â”‚   â”œâ”€â”€ pgbackrest.conf
â”‚   â””â”€â”€ backup-cron

Step 4: Ansible Inventory
[postgres]
pg-host ansible_host=192.168.1.10 ansible_user=root

Step 5: Ansible Playbook (Complete)
playbook.yml
---
- name: Deploy PostgreSQL with pgBackRest in Docker
  hosts: postgres
  become: true

  vars:
    image_name: postgres-pgbackrest
    container_name: pg15
    pgdata: /pgdata
    pgrepo: /pgbackrest/repo
    postgres_password: secretpassword

  tasks:

    - name: Install required packages
      apt:
        name:
          - docker.io
          - python3-docker
        state: present
        update_cache: yes

    - name: Ensure Docker is running
      service:
        name: docker
        state: started
        enabled: true

    - name: Create host directories
      file:
        path: "{{ item }}"
        state: directory
        owner: 999
        group: 999
        mode: 0755
      loop:
        - "{{ pgdata }}"
        - "{{ pgrepo }}"

    - name: Copy Dockerfile and configs
      copy:
        src: files/
        dest: /opt/pgdocker/
        mode: 0755

    - name: Build Docker image
      docker_image:
        name: "{{ image_name }}"
        tag: latest
        source: build
        build:
          path: /opt/pgdocker

    - name: Run PostgreSQL container
      docker_container:
        name: "{{ container_name }}"
        image: "{{ image_name }}"
        state: started
        restart_policy: unless-stopped
        env:
          POSTGRES_PASSWORD: "{{ postgres_password }}"
        volumes:
          - "{{ pgdata }}:/var/lib/postgresql/data"
          - "{{ pgrepo }}:/var/lib/pgbackrest"
        ports:
          - "5432:5432"

    - name: Wait for PostgreSQL to start
      wait_for:
        port: 5432
        delay: 10

    - name: Create pgBackRest stanza
      docker_container_exec:
        container: "{{ container_name }}"
        command: >
          pgbackrest --stanza=main stanza-create
      register: stanza
      failed_when: false

    - name: Check pgBackRest info
      docker_container_exec:
        container: "{{ container_name }}"
        command: pgbackrest info

Step 6: Backup Validation

Inside container:

docker exec -it pg15 pgbackrest info


Trigger manual backup:

docker exec -it pg15 pgbackrest --stanza=main backup

Step 7: Restore Process (Automated Ready)
Restore Steps (Manual but Scriptable)
docker stop pg15
rm -rf /pgdata/*
docker start pg15
docker exec -it pg15 pgbackrest --stanza=main restore


You can easily turn this into an Ansible restore playbook if you want.

What This Setup Gives You

âœ… PostgreSQL + pgBackRest in same container
âœ… Backups stored safely on host
âœ… Automated daily backups via cron
âœ… Ansible-managed lifecycle
âœ… Restore-ready architecture
âœ… Production-correct pgBackRest usage

Next Enhancements (Optional)

If you want, I can also:

Split backup & restore playbooks

Add incremental/differential backups

Add S3 repo

Add WAL archiving

Convert to docker-compose

Add monitoring / alerting

Just tell me where you want to take it ğŸš€

Please create these enhancements Split backup & restore playbooks,
Add incremental/differential backups,Add WAL archiving

Perfect â€” this is where pgBackRest really shines ğŸ”¥
Iâ€™ll extend the previous design cleanly and correctly, keeping it production-grade and Ansible-friendly.

Below youâ€™ll get:

Architecture changes

Updated pgBackRest configuration

Backup strategy (full / diff / incr)

WAL archiving

Separate Ansible playbooks

backup.yml

restore.yml

No hand-waving â€” everything is concrete and runnable.

1ï¸âƒ£ Updated Architecture (With WAL Archiving)
Host
â”œâ”€â”€ /pgdata
â”‚   â””â”€â”€ data directory
â”œâ”€â”€ /pgbackrest
â”‚   â”œâ”€â”€ repo
â”‚   â”‚   â”œâ”€â”€ backup
â”‚   â”‚   â”œâ”€â”€ archive        â† WALs stored here
â”‚   â”‚   â””â”€â”€ stanza
â””â”€â”€ Docker container
    â”œâ”€â”€ PostgreSQL
    â”œâ”€â”€ pgBackRest
    â””â”€â”€ cron (backup scheduling)

2ï¸âƒ£ PostgreSQL + pgBackRest Configuration (Updated)
pgbackrest.conf (UPDATED)
[global]
repo1-path=/var/lib/pgbackrest
repo1-retention-full=7
repo1-retention-diff=14
repo1-retention-archive=14
log-level-console=info
log-level-file=detail
start-fast=y
archive-async=y

[main]
pg1-path=/var/lib/postgresql/data

PostgreSQL WAL Archiving Configuration

Create a file postgresql.conf override:

archive_mode = on
archive_command = 'pgbackrest --stanza=main archive-push %p'
archive_timeout = 60
wal_level = replica
max_wal_senders = 5


pgBackRest automatically pulls WALs from /archive inside the repo.

3ï¸âƒ£ Backup Strategy (Best Practice)
Day	Backup Type
Sunday	Full
Monâ€“Thu	Incremental
Friday	Differential
Saturday	Incremental
Cron Jobs (backup-cron)
# Full backup (Sunday)
0 2 * * 0 postgres pgbackrest --stanza=main backup --type=full

# Differential (Friday)
0 2 * * 5 postgres pgbackrest --stanza=main backup --type=diff

# Incremental (Mon-Thu, Sat)
0 2 * * 1-4,6 postgres pgbackrest --stanza=main backup --type=incr

4ï¸âƒ£ Separate Ansible Playbooks
ğŸ“Œ inventory.ini
[postgres]
pg-host ansible_host=192.168.1.10 ansible_user=root

5ï¸âƒ£ Backup Playbook (backup.yml)

This playbook:

Validates stanza

Validates WAL archiving

Triggers on-demand backup (safe for automation)

---
- name: pgBackRest Backup Playbook
  hosts: postgres
  become: true

  vars:
    container_name: pg15
    stanza: main

  tasks:

    - name: Check pgBackRest info
      docker_container_exec:
        container: "{{ container_name }}"
        command: pgbackrest info

    - name: Check WAL archiving
      docker_container_exec:
        container: "{{ container_name }}"
        command: pgbackrest check --stanza={{ stanza }}

    - name: Run incremental backup
      docker_container_exec:
        container: "{{ container_name }}"
        command: pgbackrest --stanza={{ stanza }} backup --type=incr


ğŸ‘‰ You can override backup type:

ansible-playbook backup.yml -e "backup_type=diff"


(Replace command with --type={{ backup_type | default('incr') }} if desired.)

6ï¸âƒ£ Restore Playbook (restore.yml)

This playbook performs a safe, idempotent restore.

restore.yml
---
- name: pgBackRest Restore Playbook
  hosts: postgres
  become: true

  vars:
    container_name: pg15
    pgdata: /pgdata
    stanza: main

  tasks:

    - name: Stop PostgreSQL container
      docker_container:
        name: "{{ container_name }}"
        state: stopped

    - name: Remove PostgreSQL data directory
      file:
        path: "{{ pgdata }}"
        state: absent

    - name: Recreate PostgreSQL data directory
      file:
        path: "{{ pgdata }}"
        state: directory
        owner: 999
        group: 999
        mode: 0700

    - name: Start PostgreSQL container
      docker_container:
        name: "{{ container_name }}"
        state: started

    - name: Restore database from pgBackRest
      docker_container_exec:
        container: "{{ container_name }}"
        command: pgbackrest --stanza={{ stanza }} restore

    - name: Restart PostgreSQL container
      docker_container:
        name: "{{ container_name }}"
        state: restarted

7ï¸âƒ£ Point-in-Time Recovery (PITR) â€“ Ready

You now have WAL archiving, so PITR is trivial:

docker exec pg15 pgbackrest \
  --stanza=main \
  --type=time \
  --target="2026-02-01 10:15:00" \
  restore

8ï¸âƒ£ Validation Commands
# List backups
docker exec pg15 pgbackrest info

# Verify WALs
docker exec pg15 pgbackrest repo-ls --recurse

# Check archiving
docker exec pg15 pgbackrest check --stanza=main
